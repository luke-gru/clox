/**
 * FIXME: sometimes segfaults. Not problem with mutex, but with threading
 */
var i = 0;
var threads = [];
var list = [];
var m = Mutex();
for (var j = 0; j < 100; j+=1) {
  var t = newThread(fun() {
    for (var k = 0; k < 100; k+=1) {
      m.lock();
      i += 1;
      m.unlock();
    }
  });
  threads << t;
}

for (var j = 0; j < 100; j+=1) {
  joinThread(threads[j]);
}

print i;
